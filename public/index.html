<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="theme-color" content="#6D4AFF" />
    <title>CLOS</title>

    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="icon" href="/icons/logo.svg" type="image/svg+xml" />
    <style>
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0b12; color:#fff; }
      .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
      .card { width:min(520px, 100%); background:#141427; border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:22px; }
      .muted { opacity:.8; font-size:14px; line-height:1.6; }
      .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
      button { cursor:pointer; border:0; border-radius:12px; padding:12px 14px; background:#6D4AFF; color:#fff; font-weight:600; }
      .ghost { background:transparent; border:1px solid rgba(255,255,255,.18); }
      code { background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; }
      .ok { color:#7CFFB2; }
      .bad { color:#FF7C7C; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; word-break:break-all; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h2 style="margin:0 0 6px">تشغيل النظام…</h2>
        <div id="status" class="muted">جاري تحميل الإعدادات من <code>/app-config.json</code></div>

        <div class="row">
          <button id="retryBtn" class="ghost" type="button">إعادة المحاولة</button>
          <button id="showBtn" class="ghost" type="button">عرض الإعدادات</button>
        </div>

        <div id="details" class="muted mono" style="margin-top:12px; display:none;"></div>
      </div>
    </div>

    <script type="module">
      import { loadAppConfig } from "/js/appConfig.js";

      const statusEl = document.getElementById("status");
      const detailsEl = document.getElementById("details");
      const retryBtn = document.getElementById("retryBtn");
      const showBtn = document.getElementById("showBtn");

      let lastConfig = null;

      async function boot() {
        detailsEl.style.display = "none";
        statusEl.innerHTML = 'جاري تحميل الإعدادات من <code>/app-config.json</code>...';

        try {
          lastConfig = await loadAppConfig();
          statusEl.innerHTML = `<span class="ok">تم تحميل الإعدادات بنجاح ✅</span>`;
        } catch (e) {
          statusEl.innerHTML =
            `<span class="bad">تعذر تحميل الإعدادات ❌</span> — تأكد من وجود <code>GAS_URL</code> في Cloudflare.`;
          lastConfig = null;
          console.error(e);
        }
      }

      retryBtn.addEventListener("click", boot);
      showBtn.addEventListener("click", () => {
        detailsEl.style.display = "block";
        detailsEl.textContent = lastConfig ? JSON.stringify(lastConfig, null, 2) : "لا توجد إعدادات محمّلة.";
      });

      // Service Worker (أساس فقط - الإشعارات في مرحلة لاحقة)
      if ("serviceWorker" in navigator) {
        try {
          await navigator.serviceWorker.register("/sw.js", { scope: "/" });
        } catch (e) {
          console.warn("SW registration failed", e);
        }
      }

      boot();
    </script>
  </body>
</html>

