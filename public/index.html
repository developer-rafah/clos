<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0e0b14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="referrer" content="no-referrer" />

  <title>Clo | Rafah</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/icons/icon-192.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="/icons/icon-512.svg" />

  <style>
    :root{
      --bg:#0e0b14;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --txt:#fff;
      --muted: rgba(255,255,255,.75);
      --p:#7a5ea8; --s:#b88fcf;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(900px 520px at 75% 10%, rgba(184,143,207,.16), transparent 60%),
                  radial-gradient(700px 420px at 10% 80%, rgba(122,94,168,.14), transparent 60%),
                  linear-gradient(180deg, #0e0b14, #1a1326);
      color:var(--txt);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      overflow:hidden;
    }

    /* Fullscreen iframe */
    #frame{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      border:0;
      background:#0e0b14;
    }

    /* Loading overlay */
    #overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: rgba(14,11,20,.82);
      backdrop-filter: blur(10px);
      z-index:9999;
    }
    .card{
      width:min(560px, 100%);
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 16px;
      box-shadow: 0 18px 42px rgba(0,0,0,.45);
    }
    .row{display:flex; gap:12px; align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(122,94,168,.55), rgba(184,143,207,.45));
      border:1px solid rgba(255,255,255,.18);
      font-weight:900;
    }
    h1{margin:0;font-size:18px;font-weight:900}
    p{margin:8px 0 0; color:var(--muted); font-weight:700; line-height:1.9}
    .err{
      margin-top:12px;
      padding:12px 14px;
      border-radius:16px;
      background: rgba(251,113,133,.12);
      border:1px solid rgba(251,113,133,.35);
      color:#ffe4e6;
      display:none;
      line-height:1.8;
      font-weight:800;
      white-space:pre-wrap;
    }
    .btn{
      margin-top:12px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg, var(--p), var(--s));
    }
    .meta{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
      color: rgba(255,255,255,.65);
      font-weight:800;
      font-size:12px;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
  </style>
</head>
<body>

  <iframe id="frame" title="clos-app"></iframe>

  <div id="overlay">
    <div class="card">
      <div class="row">
        <div class="logo">C</div>
        <div>
          <h1>تشغيل النظام…</h1>
          <p>جاري تحميل الإعدادات وفتح النظام داخل التطبيق.</p>
        </div>
      </div>

      <div class="meta">
        <span class="pill" id="buildPill">BUILD: —</span>
        <span class="pill" id="originPill">ORIGIN: —</span>
      </div>

      <div class="err" id="errBox"></div>
      <button class="btn" id="retryBtn" style="display:none" onclick="boot()">إعادة المحاولة</button>
    </div>
  </div>

<script>
  const overlay = document.getElementById("overlay");
  const errBox  = document.getElementById("errBox");
  const retryBtn= document.getElementById("retryBtn");
  const frame   = document.getElementById("frame");

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg || "حدث خطأ";
    retryBtn.style.display = "block";
  }
  function hideErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
    retryBtn.style.display = "none";
  }

  async function loadConfig(){
    const res = await fetch("/app-config.json", { cache: "no-store" });
    if (!res.ok) throw new Error("Config fetch failed: " + res.status);
    return await res.json();
  }

  async function boot(){
    hideErr();

    // سجل Service Worker (لـ PWA)
    try{
      if ("serviceWorker" in navigator) {
        await navigator.serviceWorker.register("/service-worker.js", { scope: "/" });
      }
    }catch(e){
      // لا نوقف التطبيق بسبب SW
      console.warn("SW register failed:", e);
    }

    // Load runtime config
    let cfg;
    try{
      cfg = await loadConfig();
    }catch(e){
      console.error(e);
      showErr("تعذر تحميل الإعدادات.\nتأكد أن /app-config.json يعمل وأن متغير GAS_URL مضبوط في Cloudflare.\n\n" + (e && e.message ? e.message : String(e)));
      return;
    }

    document.getElementById("buildPill").textContent = "BUILD: " + (cfg.BUILD || "—");
    document.getElementById("originPill").textContent = "ORIGIN: " + location.origin;

    const gasUrl = String(cfg.GAS_URL || "").trim();
    if (!gasUrl){
      showErr("GAS_URL غير موجود في الإعدادات.\nضعه في Cloudflare Pages Environment Variables.");
      return;
    }

    // افتح نظام GAS داخل iframe
    // ملاحظة: نفتح المدخل الموحد page=auto (كما عندك)
    const url = new URL(gasUrl);
    if (!url.searchParams.get("page")) url.searchParams.set("page", "auto");

    frame.src = url.toString();

    // اخفِ شاشة التحميل بعد ما يبدأ iframe (تحميل أولي)
    frame.addEventListener("load", () => {
      overlay.style.display = "none";
    }, { once:true });
  }

  window.addEventListener("online", () => {
    // لو رجع الاتصال وواجهته كانت خطأ، جرب تلقائيًا
    if (overlay.style.display !== "none") boot();
  });

  boot();
</script>

</body>
</html>
